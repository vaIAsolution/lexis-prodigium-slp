<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEXIS PRODIGIUM - DEMO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Lora:wght@400;700&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-blue': { '500': '#00bcd4', '600': '#00acc1', '700': '#0097a7' },
                        'brand-gray': { '100': '#f8f9fa', '700': '#343a40', '800': '#212529', '900': '#1a1d20' }
                    },
                    fontFamily: { 'sans': ['Montserrat', 'sans-serif'], 'body': ['Lato', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        .demo-section { display: none; }
        .demo-section.active { display: block; }
        .prose { max-width: 100%; }
    </style>
</head>
<body class="bg-brand-gray-100 font-body text-brand-gray-800">
    <div class="flex h-screen bg-brand-gray-900">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-brand-gray-900 text-white flex-shrink-0 p-4 space-y-6 font-sans transition-all duration-300 -translate-x-full sm:translate-x-0">
             <div class="text-center">
                <h1 class="text-2xl font-bold text-brand-blue-500">LEXIS PRODIGIUM</h1>
            </div>
            <nav id="main-nav" class="space-y-2">
                <a href="#" data-demo="vigilancia" class="nav-item active flex items-center px-4 py-2 rounded-md hover:bg-brand-gray-700">Vigilancia Judicial</a>
                <a href="#" data-demo="strategy" class="nav-item flex items-center px-4 py-2 rounded-md hover:bg-brand-gray-700">Análisis de Estrategia</a>
                <a href="#" data-demo="document" class="nav-item flex items-center px-4 py-2 rounded-md hover:bg-brand-gray-700">Generador de Escritos</a>
            </nav>
            <div class="mt-auto p-4 text-center text-sm text-gray-400" id="usage-container">
                <div id="usage-message">Cargando usos...</div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-md p-4 flex justify-between items-center">
                 <button id="menu-btn" class="sm:hidden text-brand-gray-700">Menu</button>
                 <span class="font-semibold px-3 py-1 bg-green-200 text-green-800 rounded-full text-sm">DEMO EN VIVO</span>
            </header>

            <main class="flex-1 overflow-y-auto bg-brand-gray-100 p-6">
                <!-- Universal Result/Spinner Container -->
                <div id="result-container" class="max-w-4xl mx-auto hidden">
                    <div id="spinner" class="flex justify-center items-center p-10">Cargando...</div>
                    <div id="error-message" class="hidden bg-red-100 p-4"></div>
                    <div id="result-content" class="hidden bg-white p-6 rounded-lg shadow-lg prose"></div>
                    <div id="result-actions" class="hidden mt-4 flex justify-end space-x-2">
                        <button id="copy-button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Copiar</button>
                        <button id="google-search-button" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Buscar en Google</button>
                    </div>
                </div>

                <!-- Demos -->
                <section id="demo-vigilancia" class="demo-section active">
                    <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg p-6">
                        <h2 class="text-2xl font-bold">Vigilancia de Criterios Judiciales</h2>
                        <input type="text" id="vigilancia-query" class="w-full mt-4 p-2 border rounded-md" placeholder="Ej: caducidad de la instancia jalisco">
                        <button id="run-vigilancia" class="w-full mt-4 bg-brand-blue-600 text-white font-bold py-3 px-4 rounded-md">Buscar</button>
                    </div>
                </section>
                <section id="demo-strategy" class="demo-section">
                    <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg p-6">
                         <h2 class="text-2xl font-bold">Análisis de Estrategia de Caso</h2>
                         <textarea id="strategy-context" rows="8" class="w-full mt-4 p-2 border rounded-md" placeholder="Resumen de los hechos..."></textarea>
                         <button id="run-strategy" class="w-full mt-4 bg-brand-blue-600 text-white font-bold py-3 px-4 rounded-md">Analizar</button>
                    </div>
                </section>
                <section id="demo-document" class="demo-section">
                     <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg p-6">
                        <h2 class="text-2xl font-bold">Generador de Escritos</h2>
                        <input type="text" id="document-query" class="w-full mt-4 p-2 border rounded-md" placeholder="Ej: Demanda inicial de divorcio">
                        <textarea id="document-context" rows="6" class="w-full mt-4 p-2 border rounded-md" placeholder="Detalles y datos clave..."></textarea>
                        <button id="run-document" class="w-full mt-4 bg-brand-blue-600 text-white font-bold py-3 px-4 rounded-md">Generar</button>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Constantes y Variables ---
            const API_URL = '/api/proxy';
            const MAX_USES = 5;
            let isLoading = false;

            // --- Selectores de Elementos ---
            const usageMessage = document.getElementById('usage-message');
            const allButtons = document.querySelectorAll('button[id^="run-"]');

            const resultContainer = document.getElementById('result-container');
            const spinner = document.getElementById('spinner');
            const resultcontent = document.getElementById('result-content');
            const errorMessage = document.getElementById('error-message');
            const resultActions = document.getElementById('result-actions'); // Nuevo selector para los botones de acción

            // --- Funciones Principales ---

            // Actualiza la UI del contador de usos y deshabilita/habilita botones
            const updateUsageUI = (remaining) => {
                if (typeof remaining !== 'number') {
                    usageMessage.textContent = 'Error al verificar usos.';
                    allButtons.forEach(btn => btn.disabled = true);
                    return;
                }

                usageMessage.textContent = `Usos restantes: ${remaining} de ${MAX_USES}`;
                if (remaining <= 0) {
                    allButtons.forEach(btn => {
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    });
                    usageMessage.textContent = 'Límite de usos excedido.';
                } else {
                    allButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    });
                }
            };

            // Obtiene los usos iniciales desde el backend al cargar la página
            const fetchInitialUsage = async () => {
                try {
                    const response = await fetch(API_URL, { method: 'GET' });
                    if (!response.ok) throw new Error('Respuesta no válida del servidor.');
                    const data = await response.json();
                    updateUsageUI(data.remaining);
                } catch (error) {
                    console.error('Error fetching initial usage:', error);
                    updateUsageUI(null); // Pasa null para manejar el estado de error
                }
            };

            // Llama a la API con una consulta
            const callApi = async (query, context = '') => {
                if (isLoading) return; // Previene llamadas duplicadas
                isLoading = true;

                // Mostrar spinner y ocultar resultados anteriores
                resultContainer.classList.remove('hidden');
                spinner.classList.remove('hidden');
                resultcontent.classList.add('hidden');
                errorMessage.classList.add('hidden');
                resultActions.classList.add('hidden'); // Ocultar botones de acción al iniciar una nueva consulta

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query, context }),
                    });

                    // Obtener los usos restantes de la cabecera
                    const remainingUsesHeader = response.headers.get('X-Usage-Remaining');
                    if (remainingUsesHeader !== null) {
                        updateUsageUI(parseInt(remainingUsesHeader, 10));
                    }

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Ocurrió un error desconocido.');
                    
                    // Renderizar el contenido Markdown a HTML
                    resultcontent.innerHTML = marked.parse(data.result);
                    resultcontent.classList.remove('hidden');
                    resultActions.classList.remove('hidden'); // Mostrar botones de acción cuando hay resultado

                } catch (error) {
                    errorMessage.textContent = error.message;
                    errorMessage.classList.remove('hidden');
                } finally {
                    spinner.classList.add('hidden');
                    isLoading = false;
                }
            };
            
            // --- Lógica de Navegación ---
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const demoId = e.target.getAttribute('data-demo');
                    
                    document.querySelectorAll('.demo-section').forEach(section => {
                        section.classList.toggle('active', section.id === `demo-${demoId}`);
                    });
                    
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('bg-brand-blue-600'));
                    e.target.classList.add('bg-brand-blue-600');
                    resultContainer.classList.add('hidden');
                    resultActions.classList.add('hidden'); // Ocultar botones de acción al cambiar de demo
                });
            });

            // --- Asignación de Eventos a Botones ---
            document.getElementById('run-vigilancia').addEventListener('click', () => {
                const query = document.getElementById('vigilancia-query').value;
                if (query) callApi(`Busca y analiza la siguiente tesis o jurisprudencia: ${query}`);
            });

            document.getElementById('run-strategy').addEventListener('click', () => {
                const context = document.getElementById('strategy-context').value;
                if (context) callApi(`Realiza un análisis de estrategia legal tipo FODA para el siguiente caso:`, context);
            });

            document.getElementById('run-document').addEventListener('click', () => {
                const query = document.getElementById('document-query').value;
                const context = document.getElementById('document-context').value;
                if (query && context) callApi(`Genera un borrador del siguiente documento: ${query}`, context);
            });

            // --- Lógica de Botones de Acción de Resultado ---
            document.getElementById('copy-button').addEventListener('click', () => {
                const textToCopy = resultcontent.innerText;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    alert('Texto copiado al portapapeles!');
                }).catch(err => {
                    console.error('Error al copiar el texto: ', err);
                    alert('No se pudo copiar el texto.');
                });
            });

            document.getElementById('google-search-button').addEventListener('click', () => {
                const textToSearch = resultcontent.innerText; // Por ahora, busca todo el texto
                window.open(`https://www.google.com/search?q=${encodeURIComponent(textToSearch)}`, '_blank');
            });

            // --- Inicialización ---
            fetchInitialUsage();
        });
    </script>
</body>
</html>